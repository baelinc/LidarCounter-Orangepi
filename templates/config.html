<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Lidar Counter - Config</title>
<style>
    body { background:#111; font-family:Arial,sans-serif; color:#eee; margin:25px; }
    h1 { text-align:center; margin-bottom:10px; }
    .card {
        background:#222; padding:18px; border-radius:10px;
        margin-bottom:20px; box-shadow:0 3px 10px rgba(0,0,0,0.4);
    }
    label { display:block; margin:6px 0 2px 0; font-size:14px; }
    input[type=text], input[type=number], input[type=password] {
        width:100%; max-width:320px;
        padding:6px 8px; border-radius:4px; border:1px solid #555;
        background:#111; color:#eee; box-sizing:border-box;
    }
    input[type=checkbox] { transform:scale(1.1); margin-right:6px; }
    button {
        padding:10px 20px; font-size:15px; margin:5px;
        border:none; border-radius:6px; cursor:pointer;
        transition: opacity 0.2s;
    }
    button:hover { opacity: 0.8; }
    button.blue { background:#007bff; color:#fff; }
    button.red { background:#c00000; color:white; }
    button.gray { background:#555; color:#fff; }
    .smallNote { font-size:12px; color:#aaa; margin-top: 5px; }
    .grid2 {
        display:grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap:20px;
    }
    @media (max-width:900px) {
        .grid2 { grid-template-columns:1fr; }
    }
</style>
</head>
<body>

<h1>Lidar Counter - Configuration</h1>

<div style="text-align:center; margin-bottom:15px;">
    <button class="gray" onclick="location.href='/'">Back to Dashboard</button>
    <button class="gray" onclick="location.href='/schedule'">Schedule Editor</button>
</div>

<form id="cfgForm" onsubmit="saveConfig(event)">

    <div class="grid2">
        <div>
            <div class="card">
                <h2>Core Hardware</h2>
                <label>Serial Port (Orange Pi UART5)</label>
                <input type="text" id="serial_port" placeholder="/dev/ttyS5">

                <label>Baudrate</label>
                <input type="number" id="baudrate">

                <label>Database File</label>
                <input type="text" id="database">
                <div class="smallNote">Path: /root/LidarCounter-Orangepi/cars.db</div>
            </div>

            <div class="card">
                <h2>Web Server (HTTP)</h2>
                <label>Port</label>
                <input type="number" id="http_port">
                <div class="smallNote">Standard is port 80. Changes require a service restart.</div>
            </div>

            <div class="card">
                <h2>System Update (GitHub)</h2>
                <label>Repository URL</label>
                <input type="text" id="repo_url">
                
                <label>Branch</label>
                <input type="text" id="repo_branch">
                
                <div style="margin-top:15px;">
                    <button type="button" class="red" onclick="performSystemUpdate()">Pull Update & Restart</button>
                </div>
                <div class="smallNote">This force-syncs the Orange Pi with your GitHub main branch.</div>
            </div>
        </div>

        <div>
            <div class="card">
                <h2>MQTT Integration</h2>
                <label>Broker Address</label>
                <input type="text" id="mqtt_broker">

                <label>Port</label>
                <input type="number" id="mqtt_port">

                <label>Topic</label>
                <input type="text" id="mqtt_topic">

                <label>Username</label>
                <input type="text" id="mqtt_username">

                <label>Password</label>
                <input type="password" id="mqtt_password">
            </div>

            <div class="card">
                <h2>Detection Logic</h2>
                <label>Debounce (ms)</label>
                <input type="number" id="det_debounce">

                <label style="margin-top:10px;">
                    <input type="checkbox" id="det_test_mode"> Start in Test Mode
                </label>

                <label>Minimum Strength (Lidar Signal)</label>
                <input type="number" id="det_min_strength">
            </div>

            <div class="card">
                <h2>Remote Scheduling</h2>
                <label>Schedule JSON URL</label>
                <input type="text" id="sch_url">

                <label>Check Interval (seconds)</label>
                <input type="number" id="sch_interval">

                <label>GitHub Token (for private repos)</label>
                <input type="password" id="sch_token">
            </div>
        </div>
    </div>

    <div style="text-align:center; margin-bottom:30px;">
        <button class="blue" type="submit">Save Changes</button>
        <button class="red" type="button" onclick="saveAndRestart()">Save & Restart Service</button>
    </div>
</form>

<script>
async function loadConfig() {
    try {
        const r = await fetch("/api/config");
        const cfg = await r.json();

        // Core
        document.getElementById("serial_port").value = cfg.serial_port || "/dev/ttyS5";
        document.getElementById("baudrate").value = cfg.baudrate || 115200;
        document.getElementById("database").value = cfg.database || "cars.db";

        // HTTP
        const http = cfg.http || {};
        document.getElementById("http_port").value = http.port || 80;

        // System Update
        const u = cfg.system_update || {};
        document.getElementById("repo_url").value = u.repo_url || "";
        document.getElementById("repo_branch").value = u.branch || "main";

        // MQTT
        const m = cfg.mqtt || {};
        document.getElementById("mqtt_broker").value = m.broker || "localhost";
        document.getElementById("mqtt_port").value = m.port || 1883;
        document.getElementById("mqtt_topic").value = m.topic || "carcount/car_detect";
        document.getElementById("mqtt_username").value = m.username || "";
        document.getElementById("mqtt_password").value = m.password || "";

        // Detection
        const d = cfg.detection || {};
        document.getElementById("det_debounce").value = d.debounce_ms || 200;
        document.getElementById("det_min_strength").value = d.min_strength || 100;
        document.getElementById("det_test_mode").checked = !!d.test_mode;

        // Schedule
        const s = cfg.schedule || {};
        document.getElementById("sch_url").value = s.url || "";
        document.getElementById("sch_interval").value = s.check_interval_sec || 1200;
        document.getElementById("sch_token").value = s.github_token || "";

    } catch(e) {
        console.error("loadConfig error", e);
        alert("Critical: Failed to load configuration from Orange Pi.");
    }
}

async function saveConfig(ev) {
    if (ev) ev.preventDefault();

    const payload = {
        serial_port: document.getElementById("serial_port").value,
        baudrate: parseInt(document.getElementById("baudrate").value),
        database: document.getElementById("database").value,
        http: {
            port: parseInt(document.getElementById("http_port").value)
        },
        system_update: {
            repo_url: document.getElementById("repo_url").value,
            branch: document.getElementById("repo_branch").value,
            local_path: "/root/LidarCounter-Orangepi",
            service_name: "LidarCounter.service"
        },
        mqtt: {
            broker: document.getElementById("mqtt_broker").value,
            port: parseInt(document.getElementById("mqtt_port").value),
            topic: document.getElementById("mqtt_topic").value,
            username: document.getElementById("mqtt_username").value,
            password: document.getElementById("mqtt_password").value
        },
        detection: {
            debounce_ms: parseInt(document.getElementById("det_debounce").value),
            min_strength: parseInt(document.getElementById("det_min_strength").value),
            test_mode: document.getElementById("det_test_mode").checked
        },
        schedule: {
            url: document.getElementById("sch_url").value,
            check_interval_sec: parseInt(document.getElementById("sch_interval").value),
            github_token: document.getElementById("sch_token").value
        }
    };

    try {
        const r = await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (j.status === "success" || j.ok) {
            alert("Configuration saved successfully.");
            return true;
        } else {
            alert("Save failed: " + (j.message || "Unknown error"));
            return false;
        }
    } catch(e) {
        alert("Error: Could not reach the server to save settings.");
        return false;
    }
}

async function saveAndRestart() {
    if (!confirm("Save settings and restart the Lidar service?")) return;

    const saved = await saveConfig();
    if (!saved) return;

    try {
        await fetch("/api/service/restart", { method: "POST" });
        alert("Restarting... Page will reload in 10 seconds.");
        setTimeout(() => location.href = "/", 10000);
    } catch (e) {
        alert("Service restart command sent. Please refresh manually.");
    }
}

function performSystemUpdate() {
    if(confirm("DANGER: This will overwrite local changes with the GitHub version and restart the system. Proceed?")) {
        fetch('/run_update', { method: 'POST' })
            .then(response => {
                alert("Update initiated. Please wait 15 seconds for the system to rebuild and restart.");
                setTimeout(() => { location.reload(); }, 15000);
            })
            .catch(err => {
                alert("Update triggered. Refreshing shortly...");
                setTimeout(() => { location.reload(); }, 12000);
            });
    }
}

// Initial Load
loadConfig();
</script>

</body>
</html>
