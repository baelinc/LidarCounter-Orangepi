<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Lidar Car Counter - Dashboard</title>
<style>
    body { background:black; font-family:Arial, sans-serif; color:white; margin:25px; }
    .center { text-align:center; }
    .card {
        background:#222; padding:18px; border-radius:10px;
        margin-bottom:20px; box-shadow:0 3px 10px rgba(0,0,0,0.4);
    }
    .valueBox {
        background:#eee; color:black; padding:8px 14px;
        border-radius:6px; font-size:20px; display:inline-block; min-width:90px;
    }
    .led {
        display:inline-block; width:14px; height:14px; border-radius:50%;
        margin-left:8px; background:#660000;
        box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    .led.green { background:#00c000; box-shadow: 0 0 8px #00ff00; }
    button {
        padding:10px 20px; font-size:15px; margin:5px;
        border:none; border-radius:6px; cursor:pointer;
        transition: 0.2s;
    }
    button:hover { opacity: 0.8; }
    button.blue { background:#007bff; color:white; }
    button.red { background:#c00000; color:white; }
    button.gray { background:#555; color:white; }
    
    .layout {
        display:grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap:20px;
    }
    @media (max-width:900px) {
        .layout { grid-template-columns: 1fr; }
    }
    .statRow { margin:10px 0; font-size: 16px; }
    .statLabel { display:inline-block; width:140px; color: #aaa; }
    
    canvas { 
        width: 100% !important;
        max-height: 300px;
        background:#111;
        border-radius:8px;
        padding:10px;
    }
    #pi-clock { font-weight: bold; color: #007bff; font-size: 1.2em; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<h1 class="center">Lidar Car Counter</h1>

<div class="card">
    <h2>24-Hour Traffic Flow</h2>
    <div style="position: relative; height:300px; width:100%;">
        <canvas id="hourChart"></canvas>
    </div>
</div>

<div class="layout">
    <div>
        <div class="card">
            <h2>Live Sensor Data</h2>
            <div class="statRow">
                <span class="statLabel">Distance:</span>
                <span id="dist" class="valueBox">--</span> mm
            </div>
            <div class="statRow">
                <span class="statLabel">Strength:</span>
                <span id="str" class="valueBox">--</span>
            </div>
            <div class="statRow">
                <span class="statLabel">Car Present:</span>
                <span id="present" class="valueBox">--</span>
            </div>
        </div>

        <div class="card">
            <h2>System & Schedule</h2>
            <div class="statRow">
                Schedule Active: <span id="schedActiveLED" class="led"></span>
            </div>
            <div class="statRow">
                Status: <span id="schedStatus" class="valueBox" style="min-width:180px;">Loading...</span>
            </div>
            <div class="statRow" style="border-top: 1px solid #444; padding-top: 15px;">
                <p><strong>System Time:</strong> <span id="pi-clock">--:--:--</span></p>
                <button id="sync-btn" class="gray" onclick="syncTime()">Sync Time (Google)</button>
            </div>
        </div>
    </div>

    <div>
        <div class="card">
            <h2>Count History</h2>
            <div class="statRow">
                <span class="statLabel">Today:</span>
                <span id="cntToday" class="valueBox">--</span>
            </div>
            <div class="statRow">
                <span class="statLabel">Yesterday:</span>
                <span id="cntYesterday" class="valueBox">--</span>
            </div>
            <div class="statRow">
                <span class="statLabel">All Time:</span>
                <span id="cntTotal" class="valueBox">--</span>
            </div>
        </div>

        <div class="card">
            <h2>Operation Overrides</h2>
            <div class="statRow">
                <span class="statLabel">Test Mode:</span>
                <span id="modeTest" class="valueBox">--</span>
            </div>
            <div class="statRow">
                <span class="statLabel">Manual Override:</span>
                <span id="modeOverride" class="valueBox">--</span>
            </div>
            <div style="margin-top:15px;">
                <button class="blue" onclick="toggleMode('test_mode')">Toggle Test</button>
                <button class="red" onclick="toggleMode('manual_override')">Toggle Override</button>
            </div>
        </div>
    </div>
</div>

<div class="center" style="margin-top:20px; padding-bottom: 40px;">
    <button class="gray" onclick="location.href='/config'">System Config</button>
    <button class="gray" onclick="location.href='/schedule'">Edit Schedule</button>
    <br><br>
    <div class="card" style="display:inline-block; border: 1px solid #444;">
        <h3>Data Management</h3>
        <button class="blue" onclick="window.location.href='/download_csv'">Export CSV</button>
        <button class="red" onclick="clearData()">Reset Database</button>
    </div>
</div>

<script>
let hourChart = null;
let currentLocalState = {};

// Clock functionality
function updateClock() {
    const now = new Date();
    document.getElementById('pi-clock').innerText = now.toLocaleTimeString();
}
setInterval(updateClock, 1000);

async function syncTime() {
    const btn = document.getElementById('sync-btn');
    btn.disabled = true; btn.innerText = "Syncing...";
    try {
        const r = await fetch('/sync_time', { method: 'POST' });
        const j = await r.json();
        alert(j.status === "success" ? "Time synchronized!" : "Sync failed.");
    } catch(e) { alert("Network error syncing time."); }
    btn.disabled = false; btn.innerText = "Sync Time (Google)";
}

// Data Loading
async function loadAllData() {
    try {
        const r = await fetch("/api/status");
        const j = await r.json();
        currentLocalState = j;

        // Sensor
        document.getElementById("dist").textContent = j.current_distance || "0";
        document.getElementById("str").textContent = j.current_strength || "0";
        document.getElementById("present").textContent = j.car_present ? "YES" : "NO";

        // Schedule
        document.getElementById("schedActiveLED").classList.toggle("green", !!j.is_active_by_schedule);
        document.getElementById("schedStatus").textContent = j.schedule_status || "Unknown";

        // Mode
        document.getElementById("modeTest").textContent = j.test_mode ? "ON" : "OFF";
        document.getElementById("modeOverride").textContent = j.manual_override ? "ON" : "OFF";
        
    } catch(e) { console.error("Update loop error", e); }
}

async function loadStats() {
    try {
        const r = await fetch("/api/stats/hourly");
        const j = await r.json();
        updateChart(j.labels, j.values);
        
        // Use standard status API for counts to keep things simple
        const r2 = await fetch("/api/status");
        const j2 = await r2.json();
        // Assuming your backend provides these in a /api/stats endpoint:
        // For now, mapping placeholders
        document.getElementById("cntTotal").textContent = j2.total_count || "0";
    } catch(e) { console.error("Stats error", e); }
}

function updateChart(labels, data) {
    const ctx = document.getElementById("hourChart").getContext("2d");
    if (!hourChart) {
        hourChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [{
                    label: "Vehicles",
                    data: data,
                    backgroundColor: "#007bff",
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: "#333" } },
                    x: { grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    } else {
        hourChart.data.labels = labels;
        hourChart.data.datasets[0].data = data;
        hourChart.update();
    }
}

async function toggleMode(key) {
    const newVal = !currentLocalState[key];
    try {
        await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ [key]: newVal })
        });
        loadAllData();
    } catch(e) { alert("Failed to toggle mode."); }
}

function clearData() {
    if(confirm("Permanently delete ALL car records?")) {
        fetch('/clear_db', { method: 'POST' })
            .then(() => { alert("Database cleared."); location.reload(); });
    }
}

// Intervals
setInterval(loadAllData, 1000); // Fast update for distance
setInterval(loadStats, 30000); // Slow update for chart
loadAllData();
loadStats();
updateClock();
</script>

</body>
</html>
